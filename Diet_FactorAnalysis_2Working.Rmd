---
title: "R Notebook"
output: html_notebook
---

```{r}

library(readxl)
library(RNHANES)
library(tidyverse)
library(dplyr)
library(devtools)
library(SASxport)



library(factoextra)
library(psych)
library(corrplot)
library(ggplot2)
library(xlsx)
library(survey)

library(nFactors)

library(broom.helpers)
library(forestmodel)
library(ggplot2)
library(ggstance)
library(ggpubr)
library(gridExtra)
library(mice)
library(VIM)
library(rlist)
library(sm)


library(sjPlot)
library(RColorBrewer)



library(geometry)

```
Covariates:

Participants’ age, gender, race, education, income/poverty ratio, and smoking status

1. total calories, total fat, saturated fat, monounsaturated fat, polyunsaturated fat, omega-3 fatty acids, omega-6 fatty acids, protein, carbohydrate, fiber, alcohol, cholesterol, niacin, thiamin, vitamin A, vitamin B2, vitamin B6, vitamin B12, vitamin C, vitamin D, vitamin E, iron, magnesium, selenium, zinc, folic acid, β carotene, and caffeine, omega-3 fatty acids, omega-6 fatty acids

2. n3 fatty acid contained linolenic acid (18:3), stearidonic acid (18:4), eicosatetraenoic acid (20:5), clupanodonic acid (22:5), and docosahexaenoic acid (22:6)
    n6 fatty acid contained linoleic acid (18:2) and arachidonic acid (20:4)






``` {r Function that takes results from glm and makes a table with relevant info} 

glm_table_maker <- function(glm_results,i){
  
glm_summary <- summary(glm_results)[i]$coefficients


clnm <- colnames(glm_summary)
rwnm <- rownames(glm_summary) 
nrows = length(rwnm)
glm_table = data.frame((matrix(NA, nrows-1, ncol = 4)))

colnames(glm_table) <- c(clnm)

rownames(glm_table) <- gsub("`", "",rownames(glm_summary)[2:nrows], ignore.case = TRUE)
tb_rwnms <- rownames(glm_table)
#print(tb_rwnms)

index = 1
for (x in tb_rwnms){
  print(x)
  y = nchar(x)
  print(y)
  if(substring(x,y,y) == "1"){
    tb_rwnms[index] = substring(x,1,y-1)
  }
  index =index + 1
}

rownames(glm_table) <- tb_rwnms
#print(tb_rwnms)
glm_table

for (i in 2:nrows ){
      for (j in 1:4){
        if(j==4 && glm_summary[i,j] < 0.05)
        glm_table[i-1,j] = paste(formatC(glm_summary[i,j],digits = 3),"*",sep = "")
        else
        glm_table[i-1,j] = formatC(glm_summary[i,j],digits = 3)
      }
  
}
return(glm_table)
}
```



```{r diet values}

totd1 <- read.xport("Frailty/DR1TOT_H.xpt")

#select variables from totd1
totd1 <- select(totd1, SEQN,WTDRD1, WTDR2D, DR1DRSTZ, DRABF, DRDINT, DR1DAY, DR1TKCAL, DR1TPROT, DR1TCARB, DR1TSUGR,DR1TFIBE, DR1TTFAT ,DR1TSFAT, DR1TMFAT, DR1TPFAT , DR1TCHOL , DR1TATOC, DR1TATOA, DR1TVARA, DR1TBCAR, DR1TVB1, DR1TVB2, DR1TNIAC, DR1TVB6,  DR1TFA, DR1TVB12, DR1TB12A, DR1TVC, DR1TVD, DR1TVK, DR1TCALC, DR1TPHOS, DR1TMAGN, DR1TIRON , DR1TZINC, DR1TCOPP, DR1TSODI, DR1TPOTA, DR1TSELE, DR1TCAFF, DR1TALCO)

#name them
colnames(totd1) <- c("rsp_num", "D1Weight", "D2Weight", "Dietary recall status", "Breast-fed infant (either day)", "Number of days of intake", "Intake day of the week", "Energy", "Protein","Carbs","TotSugar", "fiber", "Tot_fat","Sat_fat","mfat","pfat","chol","vitE1","vitE2","vitA", "beta_carotene","vitB1","vitB2","niacin","vitB6",  "folic_acid","vitBb12_1", "vitB12_2", "vitC", "vitD", "vitK", "calcium", "phosphorous",  "magnesium", "iron", "zinc", "copper", "sodium", "potassium", "selenium", "caffeine", "alcohol")

#combine vite E1 + vitE2
totd1$vitE <- totd1$vitE1+totd1$vitE2

#combine vitB12

totd1$B12 <- totd1$vitBb12_1 + totd1$vitB12_2

#delete original columns
totd1 <- select(totd1,-c(vitE1,vitE2, vitBb12_1, vitB12_2))





#same process for totd2

totd2 <- read.xport("Frailty/DR2TOT_H.xpt")
totd2 <- select(totd2, SEQN, DR2DRSTZ, DRDINT, DR2DAY, DR2TKCAL, DR2TPROT, DR2TCARB, DR2TSUGR,DR2TFIBE, DR2TTFAT ,DR2TSFAT, DR2TMFAT, DR2TPFAT , DR2TCHOL , DR2TATOC, DR2TATOA, DR2TVARA, DR2TBCAR, DR2TVB1, DR2TVB2, DR2TNIAC, DR2TVB6,  DR2TFA, DR2TVB12, DR2TB12A, DR2TVC, DR2TVD, DR2TVK, DR2TCALC, DR2TPHOS, DR2TMAGN, DR2TIRON , DR2TZINC, DR2TCOPP, DR2TSODI, DR2TPOTA, DR2TSELE, DR2TCAFF, DR2TALCO)

colnames(totd2) <- c("rsp_num", "Dietary2 recall status", "Number of days of intake2", "Intake day of the week2", "Energy2", "Protein2","Carbs2","TotSugar2", "fiber2", "Tot_fat2","Sat_fat2","mfat2","pfat2","chol2","vitE1_2","vitE2_2","vitA2", "beta_carotene2","vitB1_2","vitB2_2","niacin_2","vitB6_2",  "folic_acid2","vitBb12_1_2", "vitB12_2_2", "vitC2", "vitD2", "vitK2", "calcium2", "phosphorous2",  "magnesium2", "iron2", "zinc2", "copper2", "sodium2", "potassium2", "selenium2", "caffeine2", "alcohol2")

#combine vite E1 + vitE2
totd2$vitE_2 <- totd2$vitE1_2 +totd2$vitE2_2

#combine vitB12

totd2$B12_2 <- totd2$vitBb12_1_2 + totd2$vitB12_2_2

#delete original columns
totd2 <- select(totd2,-c(vitE1_2,vitE2_2, vitBb12_1_2, vitB12_2_2))
head(totd2)

#merge 1 and 2 by foods for averages of 2 days
totd_foods <- (select(totd1, Energy: alcohol) + select(totd2, Energy2: alcohol2))/2
totd_foods

#create final dietary data
totd <- merge(totd1,totd2, by = "rsp_num")
totd <- select(totd,"rsp_num":"Intake day of the week", "Dietary2 recall status":"Intake day of the week2")
totd <- cbind(totd,totd_foods)

totd
#set . to NA in dietary data
totd[totd == "."] <- NA

head(totd)
#add two days together
```




```{r diet values round 2}
#Demographics + names wanted
demo <- read.xport("Frailty/DEMO_H.xpt")
demo <- select(demo, SEQN, SDDSRVYR, RIAGENDR, RIDAGEYR, RIDRETH3, DMDEDUC2, RIDEXPRG, WTINT2YR, WTMEC2YR, SDMVPSU, SDMVSTRA, INDFMPIR)
colnames(demo) <- c("rsp_num", "data_cycle", "gender", "age", "race", "education", "pregnant", "int_weight", "mec_weight", "msk_var_psu", "msk_var_strat", "incpov_ratio" )


##smoking status
smok <- read.xport("Frailty/SMQ_H.xpt")
smok <- smok[,c(1,4)]
colnames(smok) <- c("rsp_num", "curr_smok")
smok <- mutate(smok, smoker = case_when(curr_smok == "1" | curr_smok == "2" ~ 1, TRUE ~ 0)) 
demo <- merge(smok[,c(1,3)], demo, by = "rsp_num")

##Smell and taste questionnaire time
stq <- read.xport("Frailty/CSQ_H.xpt")
stq <- select(stq, SEQN, CSQ010, CSQ020, CSQ040, CSQ080, CSQ100, CSQ110, CSQ200, CSQ202, CSQ204, CSQ240, CSQ250, CSQ260)
colnames(stq) <- c("rsp_num", "prb_sm12", "ch_sm25", "phant_odor", "prb_ts12", "ch_ts_flv", "pers_ts12", "pers_cld_flu12", "pers_drym", "freq_nas_cong", "head_inj", "face_inj", "sin_inf")
stq <- mutate(stq, sr_od = case_when(prb_sm12 == "1" | ch_sm25 == "2" | phant_odor == "1" ~ 1, TRUE ~ 0)) 
stq <- mutate(stq, sr_gd = case_when(prb_ts12 == "1" | ch_ts_flv == "2" | pers_ts12 == "1" ~ 1, TRUE ~ 0))
comb <- merge(stq, demo, by = "rsp_num")

#removing all pregnant subjects
comb$pregnant <- replace_na(comb$pregnant, 5)
comb$pregnant[comb$pregnant == "1"] <- 9 ; comb$pregnant[comb$pregnant == "3"] <- 9
comb <- filter(comb, pregnant != 9)
comb$pregnant[comb$pregnant == "5"] <- NA 

#age
comb$ageNum <- comb$age
comb$age[comb$age >= 40 & comb$age < 50 ] <- 1 ; comb$age[comb$age >= 50 & comb$age < 60 ] <- 2 
comb$age[comb$age >= 60 & comb$age < 70 ] <- 3 ; comb$age[comb$age >= 70 & comb$age < 80 ] <- 4
comb$age[comb$age >= 80 ] <- 5
```


```{r diet values round 23}
#further cleaning

comb$prb_sm12[comb$prb_sm12 == "9"] <- NA 
comb$prb_sm12[comb$prb_sm12 == "1"] <- 1 ; comb$prb_sm12[comb$prb_sm12 == "2"] <- 0   
comb$ch_sm25[comb$ch_sm25 == "9"] <- NA 
comb$ch_sm25[comb$ch_sm25 == "1"] <- 0 ; comb$ch_sm25[comb$ch_sm25 == "2"] <- 1  ; comb$ch_sm25[comb$ch_sm25 == "3"] <- 0
comb$phant_odor[comb$phant_odor == "9"] <- NA 
comb$phant_odor[comb$phant_odor == "1"] <- 1 ; comb$phant_odor[comb$phant_odor == "2"] <- 0  
comb$prb_ts12[comb$prb_ts12 == "9"] <- NA 
comb$prb_ts12[comb$prb_ts12 == "1"] <- 1 ; comb$prb_ts12[comb$prb_ts12 == "2"] <- 0  
comb$ch_ts_flv[comb$ch_ts_flv == "9"] <- NA 
comb$ch_ts_flv <- case_when(comb$ch_ts_flv == "2" ~ 1, comb$ch_ts_flv == "1" ~ 0)
comb$pers_ts12[comb$pers_ts12 == "9"] <- NA 
comb$pers_ts12[comb$pers_ts12 == "1"] <- 1 ; comb$pers_ts12[comb$pers_ts12 == "2"] <- 0  
comb$pers_cld_flu12[comb$pers_cld_flu12 == "9"] <- NA 
comb$pers_cld_flu12[comb$pers_cld_flu12 == "1"] <- 1 ; comb$pers_cld_flu12[comb$pers_cld_flu12 == "2"] <- 0  
comb$pers_drym[comb$pers_drym == "9"] <- NA 
comb$pers_drym[comb$pers_drym == "1"] <- 1 ; comb$pers_drym[comb$pers_drym == "2"] <- 0  
comb$freq_nas_cong[comb$freq_nas_cong == "9"] <- NA 
comb$freq_nas_cong[comb$freq_nas_cong == "1"] <- 1 ; comb$freq_nas_cong[comb$freq_nas_cong == "2"] <- 0  
comb$head_inj[comb$head_inj == "9"] <- NA 
comb$head_inj[comb$head_inj == "1"] <- 1 ; comb$head_inj[comb$head_inj == "2"] <- 0  
comb$face_inj[comb$face_inj == "9"] <- NA 
comb$face_inj[comb$face_inj == "1"] <- 1 ; comb$face_inj[comb$face_inj == "2"] <- 0  
comb$sin_inf[comb$sin_inf == "9"] <- NA 
comb$sin_inf[comb$sin_inf == "1"] <- 1 ; comb$sin_inf[comb$sin_inf == "2"] <- 0  



comb$education[comb$education == "9"] <- NA 

ste <- read.xport("Frailty/CSX_H.xpt")
stenames <- c("rsp_num","tse_status", "tse_comcode", "quin_allg", "preg_breast", "sneeze", "discol_mucus", "nasal_block", "sinus_pain", "runny_nose", "none_above", "type_nblock", "lowint_light", "highint_light", "med_light", "low_light", "high_light", "tt1_quin", "tt1_quin_taste", "tt1_1nacl", "tt1_1nacl_taste", "wmt_quin", "wmt_quin_taste", "wmt_1nacl", "wmt_1nacl_taste", "wmt_32nacl", "wmt_32nacl_taste", "wmt_seq", "sm_choc", "sm_straw", "sm_smonk", "sm_leath", "sm_soap", "sm_grape", "sm_onion", "sm_natgas", "wmr_1nacl", "wmr_1nacl_taste", "wmr_32nacl", "wmr_32nacl_taste", "understand")
colnames(ste) <- stenames
ste <- filter(ste, tse_status != "3")
sm_tru <- cbind(ste$sm_choc == "2",   ste$sm_straw == "1",   ste$sm_smonk == "3",   ste$sm_leath == "3",   ste$sm_soap == "1",   ste$sm_grape == "2",   ste$sm_onion == "3",   ste$sm_natgas == "4"  )
sm_tru <- mutate(as.data.frame(sm_tru), corr_sm = rowSums(sm_tru))
#objective smell/taste impairment by rasmussen 2018
ste <- mutate(ste, obj_od = case_when(sm_tru$corr_sm <= 5 & !is.na(ste$sm_soap) ~ 1, TRUE ~ 0))
#gustatory dysfunction - 1mM quinine from Mattos/Churnin et al. 2019
ste <- mutate(ste, obj_gd_quin = case_when(ste$wmt_quin_taste == "2" ~ 0, ste$wmt_quin_taste == "1" | ste$wmt_quin_taste == "3" | ste$wmt_quin_taste == "4" | ste$wmt_quin_taste == "5" ~ 1)) 
#gustatory dysfunction - .32M NaCl
ste <- mutate(ste, obj_gd_32nacl = case_when(ste$wmt_32nacl_taste == "1" ~ 0, ste$wmt_32nacl_taste == "2" | ste$wmt_32nacl_taste == "3" | ste$wmt_32nacl_taste == "4" | ste$wmt_32nacl_taste == "5" ~ 1)) 
#gustatory dysfunction = 1 M NaCl
ste <- mutate(ste, obj_gd_1nacl = case_when(ste$wmt_1nacl_taste == "1" ~ 0, ste$wmt_1nacl_taste == "2" | ste$wmt_1nacl_taste == "3" | ste$wmt_1nacl_taste == "4" | ste$wmt_1nacl_taste == "5" ~ 1)) 

ste <- select(ste, rsp_num, obj_od, obj_gd_quin, obj_gd_32nacl, obj_gd_1nacl)

comb <- merge(comb, ste, by = "rsp_num")

comb <- mutate(comb, obj_gd = case_when(obj_gd_quin == "1" | obj_gd_32nacl == "1" | obj_gd_1nacl == "1" ~ 1, obj_gd_quin == "0" & obj_gd_32nacl == "0" & obj_gd_1nacl == "0" ~ 0))




```


```{r FI}
###Building frailty index
mcon1314 <- read.xport("Frailty/MCQ_H.xpt")
mcon1314 <- select(mcon1314, SEQN, MCQ160F, MCQ160M,  MCQ220, MCQ160E, MCQ160C, MCQ160D, MCQ160A)
colnames(mcon1314) <- c("rsp_num", "stroke", "thyr_ever", "cancer", "hrt_atck", "cor_hrt_dis", "angina", "arthritis")
dis1314 <- read.xport("Frailty/DLQ_H.xpt")
dis1314 <- select(dis1314, SEQN, DLQ020)
colnames(dis1314) <- c("rsp_num", "seeing") 
mcon <- merge(dis1314, mcon1314, by = "rsp_num")

diab <- read.xport("Frailty/DIQ_H.xpt")
diab <- select(diab, SEQN, DIQ010)
colnames(diab) <- c("rsp_num", "diabetes")


kid <- read.xport("Frailty/KIQ_U_H.xpt")
kid <- select(kid, SEQN, KIQ022, KIQ042, KIQ044, KIQ046)
colnames(kid) <- c("rsp_num", "weak_fail_kid", "leak_phys", "leak_reach", "leak_nonphys")
kid <- mutate(kid, leak = case_when( leak_reach == "1" | leak_nonphys == "1" ~ 1, leak_reach == "2" & leak_nonphys == "2" ~ 2))
kid <- select(kid, rsp_num, weak_fail_kid, leak)

pfunc <- read.xport("Frailty/PFQ_H.xpt")
pfunc <- select(pfunc, SEQN, PFQ061K, PFQ061L, PFQ061J, PFQ061I, PFQ061A, PFQ061G, PFQ061M, PFQ061D, PFQ061P, PFQ061E, PFQ061T, PFQ061R, PFQ057)
colnames(pfunc) <- c("rsp_num", "diff_fork", "diff_dress", "diff_bed", "diff_chair", "diff_money", "diff_meals", "diff_standing", "diff_stoop", "diff_grasp", "diff_lift", "diff_pushp", "diff_social", "diff_rememb")

bp <- read.xport("Frailty/BPX_H.xpt")
bp <- select(bp, SEQN, BPXPLS, BPXSY1, BPXSY2, BPXSY3)
colnames(bp) <- c("rsp_num", "rest_hr", "sys_bp1", "sys_bp2", "sys_bp3")
bp <- mutate(bp, sys_bp = rowMeans(bp[,3:5]))
bp <- select(bp, rsp_num, rest_hr, sys_bp)

aud <- read.xport("Frailty/DLQ_H.xpt")
aud <- select(aud, SEQN, DLQ010)
colnames(aud) <- c("rsp_num", "diff_hear")

fol <- read.xport("Frailty/FOLFMS_H.xpt")
fol <- select(fol, SEQN, LBDFOT)
colnames(fol) <- c("rsp_num", "folate")

ghb <- read.xport("Frailty/GHB_H.xpt") 
ghb <- select(ghb, SEQN, LBXGH)
colnames(ghb) <- c("rsp_num", "hba1c")

cblood <- read.xport("Frailty/CBC_H.xpt") 
cblood <- select(cblood, SEQN, LBXRBCSI, LBXHGB, LBXRDW, LBXLYPCT, LBXNEPCT)
colnames(cblood) <- c("rsp_num", "rbc_count", "hb", "RDW", "lymphocyte", "seg_neut")

meds <- read.xport("Frailty/RXQ_RX_H.xpt")
meds <- select(meds, SEQN, RXDCOUNT, RXDUSE)
meds <- distinct(meds) ##SEQN isnt a unique identifier for this dataset
meds <- mutate(meds, medication = case_when(RXDUSE == "2" ~ 0, RXDCOUNT == "1" ~ 1, RXDCOUNT == "2" ~ 2, RXDCOUNT == "3" ~ 3, RXDCOUNT == "4" ~ 4, RXDCOUNT == "5" ~ 5, RXDCOUNT == "6" ~ 6, RXDCOUNT == "7" ~ 7, RXDCOUNT == "8" ~ 8, RXDCOUNT == "9" ~ 9, RXDCOUNT == "10" ~ 10, RXDCOUNT == "11" ~ 11, RXDCOUNT == "12" ~ 12, RXDCOUNT == "13" ~ 13, RXDCOUNT == "14" ~ 14, RXDCOUNT == "15" ~ 15, RXDCOUNT == "16" ~ 16, RXDCOUNT == "17" ~ 17, RXDCOUNT == "18" ~ 18, RXDCOUNT == "19" ~ 19, RXDCOUNT == "20" ~ 20, RXDCOUNT == "23" ~ 23 ))
meds <- select(meds, SEQN, medication)
colnames(meds) <- c("rsp_num", "medication")
meds$medication <- case_when(meds$medication < 5 ~ 0, meds$medication >= 5 ~ 1) #Vicinanza 2018 defines polypharmacy as 5 or more medications

care <- read.xport("Frailty/HUQ_H.xpt")
care <- select(care, SEQN, HUQ010, HUQ020, HUQ071)
colnames(care) <- c("rsp_num", "sr_health", "year_health", "overnight_stays")

osteo <- read.xport("Frailty/OSQ_H.xpt")
osteo <- select(osteo, SEQN, OSQ060)
colnames(osteo) <- c("rsp_num", "ost_brittle")

```


```{r}
##big fat nested merge
index <- merge(merge(merge(merge(merge(merge(merge(merge(merge(merge(merge(mcon, diab, by = "rsp_num"), kid, by = "rsp_num"), pfunc, by = "rsp_num"), bp, by = "rsp_num"), aud, by = "rsp_num"), fol, by = "rsp_num"), ghb, by = "rsp_num"), cblood, by = "rsp_num"), care, by = "rsp_num"), meds, by = "rsp_num"), osteo, by = "rsp_num")
```


```{r}
#adding gender for gender-dependent labs
boo <- select(comb, rsp_num, gender, data_cycle)
index <- merge(boo, index, by = "rsp_num")

#replacing "idk" and "refused" answers with NA
index$stroke[index$stroke == "9"] <- NA 
index$thyr_ever[index$thyr_ever == "9"] <- NA 
index$cancer[index$cancer == "9"] <- NA 
index$hrt_atck[index$hrt_atck == "9"] <- NA 
index$cor_hrt_dis[index$cor_hrt_dis == "9" | index$cor_hrt_dis == "7"] <- NA
index$angina[index$angina== "9"] <- NA 
index$arthritis[index$arthritis == "9"] <- NA 
index$seeing[index$seeing == "9"] <- NA 
index$diabetes[index$diabetes == "9"] <- NA  ## 3 = "borderline" to ever dr told have diabetes??
index$weak_fail_kid[index$weak_fail_kid == "9"] <- NA 
index$diff_fork[index$diff_fork == "9" | index$diff_fork == "5"] <- NA 
index$diff_dress[index$diff_dress == "9" | index$diff_dress == "5"] <- NA 
index$diff_bed[index$diff_bed == "9" | index$diff_bed == "5"] <- NA 
index$diff_chair[index$diff_chair == "9" | index$diff_chair == "5"] <- NA 
index$diff_money[index$diff_money == "9" | index$diff_money == "5"] <- NA 
index$diff_meals[index$diff_meals == "9" | index$diff_meals == "5"] <- NA 
index$diff_standing[index$diff_standing == "9" | index$diff_standing == "5"] <- NA
index$diff_stoop[index$diff_stoop == "9" | index$diff_stoop == "5"] <- NA 
index$diff_grasp[index$diff_grasp == "9" | index$diff_grasp == "5"] <- NA 
index$diff_lift[index$diff_lift == "9" | index$diff_lift == "5"] <- NA 
index$diff_pushp[index$diff_pushp == "7" | index$diff_pushp == "9" | index$diff_pushp == "5"] <- NA
index$diff_social[index$diff_social == "7" | index$diff_social == "5"] <- NA 
index$diff_rememb[index$diff_rememb == "9"] <- NA 
index$diff_hear[index$diff_hear == "7" | index$diff_hear == "9"] <- NA
index$seeing[index$seeing == "7" | index$seeing == "9"] <- NA
index$sr_health[index$sr_health == "7" | index$sr_health == "9"] <- NA
index$year_health[index$year_health == "9"] <- NA 
index$overnight_stays[index$overnight_stays == "7" | index$overnight_stays == "9"] <- NA 
index$ost_brittle[index$ost_brittle == "9"] <- NA 


##Recoding variables
index$stroke[index$stroke == "1"] <- 1 ; index$stroke[index$stroke == "2"] <- 0   
index$thyr_ever[index$thyr_ever == "1"] <- 1 ; index$thyr_ever[index$thyr_ever == "2"] <- 0   
index$cancer[index$cancer == "1"] <- 1 ; index$cancer[index$cancer == "2"] <- 0   
index$hrt_atck[index$hrt_atck == "1"] <- 1 ; index$hrt_atck[index$hrt_atck == "2"] <- 0   
index$cor_hrt_dis[index$cor_hrt_dis == "1"] <- 1 ; index$cor_hrt_dis[index$cor_hrt_dis == "2"] <- 0   
index$angina[index$angina == "1"] <- 1 ; index$angina[index$angina == "2"] <- 0   
index$arthritis[index$arthritis == "1"] <- 1 ; index$arthritis[index$arthritis == "2"] <- 0   
index$seeing[index$seeing == "1"] <- 1 ; index$seeing[index$seeing == "2"] <- 0   
index$weak_fail_kid[index$weak_fail_kid == "1"] <- 1 ; index$weak_fail_kid[index$weak_fail_kid == "2"] <- 0   
index$leak[index$leak == "1"] <- 1 ; index$leak[index$leak == "2"] <- 0   
index$diff_rememb[index$diff_rememb == "1"] <- 1 ; index$diff_rememb[index$diff_rememb == "2"] <- 0   
index$diff_hear[index$diff_hear == "1"] <- 1 ; index$diff_hear[index$diff_hear == "2"] <- 0
index$ost_brittle[index$ost_brittle == "1"] <- 1 ; index$ost_brittle[index$ost_brittle == "2"] <- 0  

index$diabetes <-  case_when(index$diabetes == "1" ~ 1, index$diabetes == "2" ~ 0, index$diabetes == "3" ~ 0.5)
index$diff_fork <- with(index, case_when(diff_fork == "1" ~ 0, diff_fork == "2" ~ 0.5, diff_fork == "3" ~ 0.75, diff_fork == "4" ~ 1))
index$diff_dress <- with(index, case_when(diff_dress == "1" ~ 0, diff_dress == "2" ~ 0.5, diff_dress == "3" ~ 0.75, diff_dress == "4" ~ 1))
index$diff_bed <- with(index, case_when(diff_bed == "1" ~ 0, diff_bed == "2" ~ 0.5, diff_bed == "3" ~ 0.75, diff_bed == "4" ~ 1))
index$diff_chair <- with(index, case_when(diff_chair == "1" ~ 0, diff_chair == "2" ~ 0.5, diff_chair == "3" ~ 0.75, diff_chair == "4" ~ 1))
index$diff_money <- with(index, case_when(diff_money == "1" ~ 0, diff_money == "2" ~ 0.5, diff_money == "3" ~ 0.75, diff_money == "4" ~ 1))
index$diff_meals <- with(index, case_when(diff_meals == "1" ~ 0, diff_meals == "2" ~ 0.5, diff_meals == "3" ~ 0.75, diff_meals == "4" ~ 1))
index$diff_standing <- with(index, case_when(diff_standing == "1" ~ 0, diff_standing == "2" ~ 0.5, diff_standing == "3" ~ 0.75, diff_standing == "4" ~ 1))
index$diff_stoop <- with(index, case_when(diff_stoop == "1" ~ 0, diff_stoop == "2" ~ 0.5, diff_stoop == "3" ~ 0.75, diff_stoop == "4" ~ 1))
index$diff_grasp <- with(index, case_when(diff_grasp == "1" ~ 0, diff_grasp == "2" ~ 0.5, diff_grasp == "3" ~ 0.75, diff_grasp == "4" ~ 1))
index$diff_lift <- with(index, case_when(diff_lift == "1" ~ 0, diff_lift == "2" ~ 0.5, diff_lift == "3" ~ 0.75, diff_lift == "4" ~ 1))
index$diff_pushp <- with(index, case_when(diff_pushp == "1" ~ 0, diff_pushp == "2" ~ 0.5, diff_pushp == "3" ~ 0.75, diff_pushp == "4" ~ 1))
index$diff_social <- with(index, case_when(diff_social == "1" ~ 0, diff_social == "2" ~ 0.5, diff_social == "3" ~ 0.75, diff_social == "4" ~ 1))
index$sr_health <- with(index, case_when(sr_health == "1" ~ 0, sr_health == "2" ~ 0, sr_health == "3" ~ 0, sr_health == "4" ~ 0.5, sr_health == "5" ~ 1))

index$year_health <- with(index, case_when(year_health == "1" ~ 0, year_health == "3" ~ 0, year_health == "2" ~ 1))
index$overnight_stays <- with(index, case_when(overnight_stays == "1" ~ 1, overnight_stays == "3" ~ 0, overnight_stays == "2" ~ 0))





```

```{r}

## using Hopkins labs test reference ranges for "healthy" lab ranges
index$rest_hr <- with(index, case_when(rest_hr < 60 | rest_hr > 100 ~ 1, TRUE ~ 0))
index$sys_bp <- with(index, case_when(sys_bp > 140 ~ 1, TRUE ~ 0))
index$folate <- with(index, case_when(folate > 7.2 ~ 0, TRUE ~ 1))
index$hba1c <- with(index, case_when(hba1c < 5.7 ~ 0, TRUE ~ 1))
index$rbc_count <- with(index, case_when(gender == "1" & rbc_count >= 4.5 & rbc_count <= 5.9 ~ 0, gender == "2" & rbc_count >= 4.0 & rbc_count <= 5.2 ~ 0, TRUE ~ 1 ))
index$hb <-  with (index, case_when(gender == "1" & hb >= 13.9 & hb <= 16.3 ~ 0, gender == "2" & hb >= 12.0 & hb <= 15.0 ~ 0, TRUE ~ 1 ))
index$RDW <-  with (index, case_when(RDW >= 11.5 & RDW <= 14.5 ~ 0, TRUE ~ 1))
index$lymphocyte <-  with (index, case_when(lymphocyte >= 24 & lymphocyte <= 44 ~ 0, TRUE ~ 1))
index$seg_neut <-  with (index, case_when(seg_neut >= 40 & seg_neut <= 70 ~ 0, TRUE ~ 1))


comb$gender[comb$gender == "1"] <- 0;comb$gender[comb$gender == "2"] <- 1

```


```{r}
#for missing variables, index is coded over denominator of total nonmissing values 
index
troo <- select(index, 4:42)
troo
troo <- !sapply(troo, is.na)
troo <- mutate(as.data.frame(troo), notna = rowSums(troo))
index <- mutate(index, fraildex = (rowSums(index[,c(4:42)], na.rm = T))/troo$notna)
index <- mutate(index, missing = (rowSums(is.na(index[,c(4:42)]))/39) * 100)


comb <- merge(index[,c(1,43,44)], comb, by = "rsp_num")
comb <- mutate(comb, fraildex_cat = case_when(fraildex <= 0.1 ~ 1, fraildex > 0.1 & fraildex <= 0.21 ~ 2, fraildex > 0.21 & fraildex <= 0.45 ~ 3, fraildex > 0.45 ~ 4)) 
comb$fraildex_cat <- factor(comb$fraildex_cat)
#1 = "nonfrail", 2 = vulnerable, 3 = frail, 4 = most frail; Blodgett et al. 2014; Hoover, Rotermann, Sanmartin, & Bernier, 2013



#add diet
comb <- merge(totd,comb,by = "rsp_num")

bmi <- read.xport("Frailty/BMX_H.xpt")
head(bmi)
bmi <- select(bmi, SEQN, BMXBMI)
colnames(bmi) <- c("rsp_num","bmi")
comb <- merge(comb,bmi,by = "rsp_num")


#change comb to diet
diet <- comb



comb#filter out those with diet on both days
diet <- diet[diet$`Dietary2 recall status` == 1, ]


```

```{r Energy Adjustment by dividng by kcal}
#subsetting foods
ener <- select(diet, Energy:alcohol)

#initialize df for adjusted values
adjustedEner <- ener


for (i in c(2:31)){
  
  adjustedEner[,i] <- ener[,i]/ener[1]
}

#same diet set with energy adjusted foods
diet_adjusted <- diet
diet_adjusted[11:41] <- adjustedEner

```




```{r Correlation Test}

datamatrix <- cor(select(diet, Protein:alcohol))

corrplot(datamatrix, method="number")

```


```{r Kaiser-Myer-Olkin}
#KMO ≥ 60 = factorable
fooz <- select(diet, Protein:alcohol)
KMO(r=cor(fooz))


```


```{r Bartlett’s Test of Sphericity}
#Small values (8.84e-290 < 0.05) of the significance level indicate that a factor analysis may be useful with our data.
cortest.bartlett(fooz)

```

```{r Determinant}
#should be positive
det(cor(fooz))

```





```{r Scree Pilot}
fafitfree <- fa(fooz, nfactors = ncol(fooz), rotate = "none")
n_factors <- length(fafitfree$e.values)

scree <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = fafitfree$e.values)


ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")


```


```{r Parallel Analysis}
#parallel <- fa.parallel(X)
#parallel$values
```


```{r Number of factors}
nScree(fooz)
```





```{r}
#chemosensory dysfunction
diet$obj_od <- as.factor(diet$obj_od)
diet$obj_gd <- as.factor(diet$obj_gd)
diet$obj_gd_quin <- as.factor(diet$obj_gd_quin)
diet$obj_gd_32nacl <- as.factor(diet$obj_gd_32nacl)
diet$obj_gd_1nacl <- as.factor(diet$obj_gd_1nacl)
diet$sr_od <- as.factor(diet$sr_od)

#demographics
diet$age <- as.factor(diet$age)
diet$ageNum <- as.numeric(diet$ageNum)
diet$gender <- as.factor(diet$gender)
diet$incpov_ratio <- as.numeric(diet$incpov_ratio)
diet$education <- as.factor(diet$education)
diet$smoker <- as.factor(diet$smoker)
diet$race <- as.factor(diet$race)
levels(diet$race) = c("Mexican American", "Other Hispanic", "Non-hispanic White", "Non-Hispanic Black", "Non-Hispanic Asian", "Other Race - Including Multi-Racial")
diet$bmi <- as.numeric(diet$bmi)

#energy

diet$Energy <- as.numeric(diet$Energy)

#frailty
diet$fraildex_cat <- as.numeric(diet$fraildex_cat)

#frailty for log models
diet$frail_log <- diet$fraildex_cat
diet$frail_log[diet$frail_log == 1 | diet$frail_log == 2] <- 0
diet$frail_log[diet$frail_log == 3 | diet$frail_log == 4] <- 1

diet$frail_log <- as.factor(diet$frail_log)
diet$fraildex_cat <- as.factor(diet$fraildex_cat)

diet$fraildex <- as.numeric(diet$fraildex)


#add history of nasal issues
diet<- mutate(diet, his_sd = case_when(pers_cld_flu12 == "1" | freq_nas_cong == "1" | head_inj == "1"|sin_inf == "1" ~ 1, TRUE ~ 0))

```


```{r Survery design objects for factor analysis}

#D2 weights used here
diet_factanal.unadjusted <- svydesign(id = ~msk_var_psu, strata = ~msk_var_strat, weights = ~D2Weight, nest = TRUE, data = diet)

diet.facatanal.adjusted<- svydesign(id = ~msk_var_psu, strata = ~msk_var_strat, weights = ~D2Weight, nest = TRUE, data = diet_adjusted)
```





```{r}
fa.unadjusted <- svyfactanal(~Protein+Carbs+ TotSugar + fiber + Tot_fat + Sat_fat + mfat+pfat+chol+vitA+beta_carotene+vitB1 + vitB2 + niacin + vitB6 + folic_acid + vitC + vitD + vitK + calcium + phosphorous + magnesium + iron + zinc + copper + sodium + potassium + selenium + caffeine + alcohol, diet_factanal.unadjusted, factors = 4)


fa.adjusted <- svyfactanal(~Protein+Carbs+ TotSugar + fiber + Tot_fat + Sat_fat + mfat+pfat+chol+vitA+beta_carotene+vitB1 + vitB2 + niacin + vitB6 + folic_acid + vitC + vitD + vitK + calcium + phosphorous + magnesium + iron + zinc + copper + sodium + potassium + selenium + caffeine + alcohol, diet.facatanal.adjusted, factors = 4)

```




```{r Get loadings of adjusted and unadjusted}

#loadings and scores for ua and adj
svyload.ua <- fa.unadjusted$loadings 
svyload.ua <- varimax(fa.unadjusted$loadings)
svyload.a <- fa.adjusted$loadings 
svyload.a <- varimax(fa.adjusted$loadings)

#prepare loadings for matrix multiplication to get scores

svyload.ua <- as.data.frame(unclass(svyload.ua[[1]]))
write.xlsx(svyload.ua,file = "loadingsUA.xlsx")


svyload.a <- as.data.frame(unclass(svyload.a[[1]]))
write.xlsx(svyload.a,file = "loadingsA.xlsx")


#prepare foods for matrix mult
fooz <- scale(fooz, scale = TRUE)
fooz <- as.matrix(fooz)
svyscores.ua <- (fooz %*% as.matrix(svyload.ua))
svyscores.a <- (fooz %*% as.matrix(svyload.a))

#svyscores <- (X %*% solve(cor(X)) %*% svyloadings)


#unadjusted survey scores
diet$ua.dp1 <- as.numeric(svyscores.ua[,1])
diet$ua.dp2 <- as.numeric(svyscores.ua[,2])
diet$ua.dp3 <- as.numeric(svyscores.ua[,3])
diet$ua.dp4 <- as.numeric(svyscores.ua[,4])

#adjusted survey scores

diet$a.dp1 <- as.numeric(svyscores.a[,1])
diet$a.dp2 <- as.numeric(svyscores.a[,2])
diet$a.dp3 <- as.numeric(svyscores.a[,3])
diet$a.dp4 <- as.numeric(svyscores.a[,4])

diet$age <- as.ordered(diet$age)

```


```{r Quantiles for both scores}

#unadjusted quantiles

quantile.ua1 <- as.factor(ntile(diet$ua.dp1, 3))
levels(quantile.ua1) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.ua1 <- quantile.ua1

quantile.ua2 <- as.factor(ntile(diet$ua.dp2, 3))
levels(quantile.ua2) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.ua2 <- quantile.ua2

quantile.ua3 <- as.factor(ntile(diet$ua.dp3, 3))
levels(quantile.ua3) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.ua3 <- quantile.ua3

quantile.ua4 <- as.factor(ntile(diet$ua.dp4, 3))
levels(quantile.ua4) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.ua4 <- quantile.ua4

#adjusted quantiles

quantile.a1 <- as.factor(ntile(diet$a.dp1, 3))
levels(quantile.a1) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.a1 <- quantile.a1

quantile.a2 <- as.factor(ntile(diet$a.dp2, 3))
levels(quantile.a2) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.a2 <- quantile.a2

quantile.a3 <- as.factor(ntile(diet$a.dp3, 3))
levels(quantile.a3) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.a3 <- quantile.a3

quantile.a4 <- as.factor(ntile(diet$a.dp4, 3))
levels(quantile.a4) = c("lowest", "2nd quartile", "3rd quartile")
diet$quantile.a4 <- quantile.a4



#diet$quantile <- relevel(diet$quantile, ref = "4th quant")

#diet <- within(diet, quantile <- relevel(quantile, ref = "least risk" ))

#levels(diet$quantile) <- c("greatest risk", "2nd quant", "3rd quant", "4th quant", "5th quant")

```


```{r}
#check normality

```


```{r}
#stderr function
std <- function(x) sd(x)/sqrt(length(x))

#Descriptive stats
do1 <- filter(diet,(diet$ageNum < 60) & (diet$gender == 0) & diet$obj_od == 1) %>% select(.,ageNum, bmi,race, incpov_ratio, smoker, Energy, quantile.a1, quantile.a2,quantile.a3,quantile.a4)
do2 <- filter(diet,(diet$ageNum < 60) & (diet$gender == 1) & diet$obj_od == 1) %>% select(.,ageNum, bmi,race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3,quantile.a4)
do3 <- filter(diet,(diet$ageNum >= 60) & (diet$gender == 0) & diet$obj_od == 1)%>% select(.,ageNum, bmi,race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3,quantile.a4)
do4 <- filter(diet,(diet$ageNum >= 60) & (diet$gender == 1) & diet$obj_od == 1)%>% select(.,ageNum, bmi, race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3,quantile.a4)

d1 <- filter(diet,(diet$ageNum < 60) & (diet$gender == 0) & diet$obj_od == 0)%>% select(.,ageNum, bmi, race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3,quantile.a4)
d2 <- filter(diet,(diet$ageNum < 60) & (diet$gender == 1) & diet$obj_od == 0)%>% select(.,ageNum, bmi, race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3,quantile.a4)
d3 <- filter(diet,(diet$ageNum >= 60) & (diet$gender == 0) & diet$obj_od == 0)%>% select(.,ageNum, bmi, race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3,quantile.a4)
d4 <- filter(diet,(diet$ageNum >= 60) & (diet$gender == 1) & diet$obj_od == 0)%>% select(.,ageNum, bmi, race, incpov_ratio, smoker, Energy,quantile.a1,quantile.a2,quantile.a3, quantile.a4)



         


desc <- function (x) {
  desc.rez <- list() 
  num_var <- dim(x)[2]
  desc.rez <- list.append(desc.rez, dim(x)[1])
  for (i in c(1:num_var)){
    if(is.factor(x[,i]) == FALSE){
      desc.rez <- list.append(desc.rez,  (paste(round(mean(x[,i], na.rm = TRUE), digits = 2), round(std(x[,1]),   digits = 2), sep = "±") ))
      
}
    else if (is.factor(x[,i])){
      desc.rez <- list.append(desc.rez, table(x[i]))
      desc.rez <- list.append(desc.rez, (round(table(x[i])/dim(x)[1],2)))
         
    }
  }
  desc.rez <- setNames(desc.rez, c("n","age", "bmi","raceNum", "raceProp", "inc_pov", "smokerNum", "smokerprop" ,"Energy", "quartile.a1","prop", "quartile.a2","prop", "quartile.a3","prop", "quartile.a4","prop")) 
  desc.rez <- as.data.frame(desc.rez)
  desc.rez <- desc.rez[-6]
  desc.rez$raceNum.Freq <- paste(paste(desc.rez$raceNum.Freq, desc.rez$raceProp.Freq, sep = " ("), ")", sep = "")
desc.rez$smokerNum.Freq <- paste(paste(desc.rez$smokerNum.Freq, desc.rez$smokerprop.Freq, sep = " ("), ")", sep = "")
desc.rez$quartile.a1.Freq <- paste(paste(desc.rez$quartile.a1.Freq, desc.rez$prop.Freq, sep = " ("), ")", sep = "")
desc.rez$quartile.a2.Freq <- paste(paste(desc.rez$quartile.a2.Freq, desc.rez$prop.Freq.1, sep = " ("), ")", sep = "")
desc.rez$quartile.a3.Freq <- paste(paste(desc.rez$quartile.a3.Freq, desc.rez$prop.Freq.2, sep = " ("), ")", sep = "")
desc.rez$quartile.a4.Freq <- paste(paste(desc.rez$quartile.a4.Freq, desc.rez$prop.Freq.3, sep = " ("), ")", sep = "")

rtprez <- as.data.frame(c(desc.rez$age[1], desc.rez$bmi[1], desc.rez$raceNum.Freq[1:6], desc.rez$inc_pov[1], desc.rez$smokerNum.Freq[1:2], desc.rez$Energy[1],desc.rez$quartile.a1.Freq[1:3],desc.rez$quartile.a2.Freq[1:3], desc.rez$quartile.a3.Freq[1:3],desc.rez$quartile.a4.Freq[1:3]))

return(rtprez)
}
```


```{r}
#ym
do1.rez <- desc(do1)
d1.rez <- desc(d1)

do2.rez <- desc(do2)
dim(do2)[1]
d2.rez <- desc(d2)
dim(d2)[1]

do3.rez <- desc(do3)
dim(do3)[1]
d3.rez <- desc(d3)
dim(d3)[1]

do4.rez <- desc(do4)
dim(do4)[1]
d4.rez <- desc(d4)
dim(d4)[1]
```


```{r}
library(mvoutlier)

svyranktest(bmi ~ obj_od, dsub1, test = "wilcoxon")
svyranktest(bmi ~ obj_od, dsub2, test = "wilcoxon")
svyranktest(bmi ~ obj_od, dsub3, test = "wilcoxon")
svyranktest(bmi ~ obj_od, dsub4, test = "wilcoxon")

svychisq(~race  + obj_od, dsub1)
svychisq(~race  + obj_od, dsub2)
svychisq(~race  + obj_od, dsub3)
svychisq(~race  + obj_od, dsub4)

svyranktest(incpov_ratio ~ obj_od, dsub1, test = "wilcoxon")
svyranktest(incpov_ratio ~ obj_od, dsub2, test = "wilcoxon")
svyranktest(incpov_ratio ~ obj_od, dsub3, test = "wilcoxon")
svyranktest(incpov_ratio ~ obj_od, dsub4, test = "wilcoxon")

svychisq(~smoker  + obj_od, dsub1)
svychisq(~smoker + obj_od, dsub2)
svychisq(~smoker  + obj_od, dsub3)
svychisq(~smoker + obj_od, dsub4)

svyranktest(Energy ~ obj_od, dsub1, test = "wilcoxon")
svyranktest(Energy ~ obj_od, dsub2, test = "wilcoxon")
svyranktest(Energy~ obj_od, dsub3, test = "wilcoxon")
svyranktest(Energy ~ obj_od, dsub4, test = "wilcoxon")

svychisq(~quantile.a1  + obj_od, dsub1)
svychisq(~quantile.a1 + obj_od, dsub2)
svychisq(~quantile.a1  + obj_od, dsub3)
svychisq(~quantile.a1 + obj_od, dsub4)

svychisq(~quantile.a2  + obj_od, dsub1)
svychisq(~quantile.a2 + obj_od, dsub2)
svychisq(~quantile.a2  + obj_od, dsub3)
svychisq(~quantile.a2 + obj_od, dsub4)

svychisq(~quantile.a3  + obj_od, dsub1)
svychisq(~quantile.a3 + obj_od, dsub2)
svychisq(~quantile.a3  + obj_od, dsub3)
a <- svychisq(~quantile.a3 + obj_od, dsub4)

svychisq(~quantile.a4  + obj_od, dsub1)
svychisq(~quantile.a4 + obj_od, dsub2)
svychisq(~quantile.a4  + obj_od, dsub3)
svychisq(~quantile.a4 + obj_od, dsub4)


```

```{r Survery design for regressions}
#survey design object for analysis and regressions
#weights used are int_weight
diet_sur <- svydesign(id = ~msk_var_psu, strata = ~msk_var_strat, weights = ~int_weight, nest = TRUE, data = diet)

diet_sur1 <- subset(diet_sur, diet$his_sd == 0)
#subset of older > 60
dsub1 <- subset(diet_sur,(diet$ageNum < 60) & (diet$gender == 0) )
dsub2 <- subset(diet_sur,(diet$ageNum < 60) & (diet$gender == 1))
dsub3 <- subset(diet_sur,(diet$ageNum >= 60) & (diet$gender == 0))
dsub4 <- subset(diet_sur,(diet$ageNum >= 60) & (diet$gender == 1))

#subset excluding sr_od
dsub5 <- subset(diet_sur, (diet$ageNum > 60))

svychisq(~obj_od + quantile.a1, design = dsub1)
svychisq(~obj_od + quantile.a1, design = dsub2)
svychisq(~obj_od+ quantile.a1, design = dsub3)
svychisq(~obj_od + quantile.a1, design = dsub4)
svychisq(~obj_od + quantile.a1, design = diet_sur)

svychisq(~obj_od + quantile.a2, design = dsub1)
svychisq(~obj_od + quantile.a2, design = dsub2)
svychisq(~obj_od+ quantile.a2, design = dsub3)
svychisq(~obj_od + quantile.a2, design = dsub4)
svychisq(~obj_od + quantile.a2, design = diet_sur)

svychisq(~obj_od + quantile.a3, design = dsub1)
svychisq(~obj_od + quantile.a3, design = dsub2)
svychisq(~obj_od+ quantile.a3, design = dsub3)
svychisq(~obj_od + quantile.a3, design = dsub4)
svychisq(~obj_od + quantile.a3, design = diet_sur)

svychisq(~obj_od + quantile.a4, design = dsub1)
svychisq(~obj_od + quantile.a4, design = dsub2)
svychisq(~obj_od+ quantile.a4, design = dsub3)
svychisq(~obj_od + quantile.a4, design = dsub4)
svychisq(~obj_od + quantile.a4, design = diet_sur)



a.of.fit1<- svyglm(obj_od ~ a.dp3 + race + bmi + smoker + incpov_ratio , design = dsub3, family = "quasibinomial")
summary(a.of.fit1)

forest_model(a.of.fit1)

```



```{r chi square}



dsg = diet_sur

 rez <- rbind(summary(svyglm(obj_od ~ a.dp1, design = dsg, family = "quasibinomial"))$coefficients[2,4],
summary(svyglm(obj_od ~ a.dp2, design = dsg, family = "quasibinomial"))$coefficients[2,4],
summary(svyglm(obj_od ~ a.dp3, design = dsg, family = "quasibinomial"))$coefficients[2,4],
summary(svyglm(obj_od ~ a.dp4, design = dsg, family = "quasibinomial"))$coefficients[2,4])
 
 rez[,1]

dsg = dsub1
summary(svyglm(obj_od ~ a.dp1, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp2, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp3, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp4, design = dsg, family = "quasibinomial"))

dsg = dsub2
summary(svyglm(obj_od ~ a.dp1, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp2, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp3, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp4, design = dsg, family = "quasibinomial"))

dsg = dsub3
summary(svyglm(obj_od ~ a.dp1, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp2, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp3, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp4, design = dsg, family = "quasibinomial"))

dsg = dsub4
summary(svyglm(obj_od ~ a.dp1, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp2, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp3, design = dsg, family = "quasibinomial"))
summary(svyglm(obj_od ~ a.dp4, design = dsg, family = "quasibinomial"))






a<-svytable(~quantile.a4 + frail_log , dsub4)
CochranArmitageTest(a, alternative = "i")

fit1<- svyglm(fraildex ~ a.dp4 + race + incpov_ratio + bmi + smoker + obj_od, design = diet_sur, family = "gaussian")
summary(fit1)

forest_model(fit1)

summary(fit1)

```

```{r Barplots}
#ajusted.of bars
odq1.of <- svytable(~obj_od + quantile.a1, design = dsub4)
barodq1.of <- odq1.of[2,]/(odq1.of[1,] + odq1.of[2,])


odq2.of <- svytable(~obj_od + quantile.a2, design = dsub4)
barodq2.of <- odq2.of[2,]/(odq2.of[1,] + odq2.of[2,])


odq3.of <- svytable(~obj_od + quantile.a3, design = dsub4)
barodq3.of <- odq3.of[2,]/(odq3.of[1,] + odq3.of[2,])


odq4.of <- svytable(~obj_od + quantile.a4, design = dsub4)
barodq4.of <- odq4.of[2,]/(odq4.of[1,] + + odq4.of[2,])

mybars.of <- data.frame("Fiber/Magnesium DP (17.5%)" = barodq1.of, "Protein and Selenium DP (11.5%)" = barodq2.of,  "Total Fat, Saturated Fat, and MUFA DP (11.2%)" = barodq3.of, "Carbs and Alcohol (5.8%)" =barodq4.of)

#ajusted.om bars

odq1.om <- svytable(~obj_od + quantile.a1, design = dsub3)
barodq1.om <- odq1.om[2,]/(odq1.om[1,] + odq1.om[2,])


odq2.om <- svytable(~obj_od + quantile.a2, design = dsub3)
barodq2.om <- odq2.om[2,]/(odq2.om[1,] + odq2.om[2,])


odq3.om <- svytable(~obj_od + quantile.a3, design = dsub3)
barodq3.om <- odq3.om[2,]/(odq3.om[1,] + odq3.om[2,])


odq4.om <- svytable(~obj_od + quantile.a4, design = dsub3)
barodq4.om <- odq4.om[2,]/(odq4.om[1,] + + odq4.om[2,])

mybars.om <- data.frame("Fiber/Magnesium DP (17.5%)" = barodq1.om, "Protein and Selenium DP (11.5%)" = barodq2.om,  "Total Fat, Saturated Fat, and MUFA DP (11.2%)" = barodq3.om, "Carbs and Alcohol (5.8%)" =barodq4.om)

#ajusted.yf bars
odq1.yf <- svytable(~obj_od + quantile.a1, design = dsub2)
barodq1.yf <- odq1.yf[2,]/(odq1.yf[1,] + odq1.yf[2,])


odq2.yf <- svytable(~obj_od + quantile.a2, design = dsub2)
barodq2.yf <- odq2.yf[2,]/(odq2.yf[1,] + odq2.yf[2,])


odq3.yf <- svytable(~obj_od + quantile.a3, design = dsub2)
barodq3.yf <- odq3.yf[2,]/(odq3.yf[1,] + odq3.yf[2,])


odq4.yf <- svytable(~obj_od + quantile.a4, design = dsub2)
barodq4.yf <- odq4.yf[2,]/(odq4.yf[1,] + + odq4.yf[2,])

mybars.yf <- data.frame("Fiber/Magnesium DP (17.5%)" = barodq1.yf, "Protein and Selenium DP (11.5%)" = barodq2.yf,  "Total Fat, Saturated Fat, and MUFA DP (11.2%)" = barodq3.yf, "Carbs and Alcohol (5.8%)" =barodq4.yf)

#ajusted.ym bars
odq1.ym <- svytable(~obj_od + quantile.a1, design = dsub1)
barodq1.ym <- odq1.ym[2,]/(odq1.ym[1,] + odq1.ym[2,])


odq2.ym <- svytable(~obj_od + quantile.a2, design = dsub1)
barodq2.ym <- odq2.ym[2,]/(odq2.ym[1,] + odq2.ym[2,])


odq3.ym <- svytable(~obj_od + quantile.a3, design = dsub1)
barodq3.ym <- odq3.ym[2,]/(odq3.ym[1,] + odq3.ym[2,])


odq4.ym <- svytable(~obj_od + quantile.a4, design = dsub1)
barodq4.ym <- odq4.ym[2,]/(odq4.ym[1,] + + odq4.ym[2,])

mybars.ym <- data.frame("Fiber/Magnesium DP (17.5%)" = barodq1.ym, "Protein and Selenium DP (11.5%)" = barodq2.ym,  "Total Fat, Saturated Fat, and MUFA DP (11.2%)" = barodq3.ym, "Carbs and Alcohol (5.8%)" =barodq4.ym)


coul <- brewer.pal(4, "Set2") 

plot.of <- barplot(as.matrix(mybars.of), main="Proportion of Olfacatory Dysfunction by Quartile of Dietary Pattern in Females over 60", ylab="Proportion with OD", beside=TRUE, col=coul, names.arg = c("Fiber/Magnesium DP ","Protein and Selenium DP ", "Total Fat, Saturated Fat, and MUFA DP ", "Carbs and Alcohol DP"), cex.names = 0.6, ylim = c(0,0.25), legend.text = TRUE, 
        args.legend = list(x = "topright", bty = "n", inset=c(-0.05, 0), cex = 0.6))

plot.om <- barplot(as.matrix(mybars.om), main="Proportion of Olfacatory Dysfunction by Quartile of Dietary Pattern in Males over 60", ylab="Proportion with OD", beside=TRUE, col=coul, names.arg = c("Fiber/Magnesium DP ","Protein and Selenium DP ", "Total Fat, Saturated Fat, and MUFA DP ", "Carbs and Alcohol DP"), cex.names = 0.6, ylim = c(0,0.35), legend.text = TRUE, 
        args.legend = list(x = "topright", bty = "n", inset=c(-0.05, 0), cex = 0.6))

plot.yf <- barplot(as.matrix(mybars.yf), main="Proportion of Olfacatory Dysfunction by Quartile of Dietary Pattern in Females under 60", ylab="Proportion with OD", beside=TRUE, col=coul, names.arg = c("Fiber/Magnesium DP ","Protein and Selenium DP ", "Total Fat, Saturated Fat, and MUFA DP ", "Carbs and Alcohol DP"), cex.names = 0.6, ylim = c(0,0.15), legend.text = TRUE, 
        args.legend = list(x = "topright", bty = "n", inset=c(-0.05, 0), cex = 0.6))

plot.ym <- barplot(as.matrix(mybars.ym), main="Proportion of Olfacatory Dysfunction by Quartile of Dietary Pattern in Males under 60", ylab="Proportion with OD", beside=TRUE, col=coul, names.arg = c("Fiber/Magnesium DP ","Protein and Selenium DP ", "Total Fat, Saturated Fat, and MUFA DP ", "Carbs and Alcohol DP"), cex.names = 0.6, ylim = c(0,0.2), legend.text = TRUE, 
        args.legend = list(x = "topright", bty = "n", inset=c(-0.05, 0), cex = 0.6))




```


Unadjusted Log Fits




```{r Regression fits for unadjusted: young males}

#unadjusted dps by quantile and obj_od
ua.ym.fit1<- svyglm(obj_od ~ quantile.ua1 + race + bmi + smoker + incpov_ratio, design = dsub1, family = "quasibinomial")
ua.ym.sum1 <-summary(ua.ym.fit1)$coefficients[1:4,]

ua.ym.fit2<- svyglm(obj_od ~ quantile.ua2  + race + bmi + smoker + incpov_ratio, design = dsub1, family = "quasibinomial")
ua.ym.sum2 <-summary(ua.ym.fit2)$coefficients[1:4,]

ua.ym.fit3<- svyglm(obj_od ~ quantile.ua3 + race + bmi + smoker + incpov_ratio, design = dsub1, family = "quasibinomial")
ua.ym.sum3 <-summary(ua.ym.fit3)$coefficients[1:4,]

ua.ym.fit4<- svyglm(obj_od ~ quantile.ua4 + race + bmi + smoker + incpov_ratio , design = dsub1, family = "quasibinomial")
ua.ym.sum4 <-summary(ua.ym.fit4)$coefficients[1:4,]


rez.ym <-rbind(ua.ym.sum1,ua.ym.sum2,ua.ym.sum3,ua.ym.sum4)

rez.ym<- sapply(rez.ym[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.ym))){
  if (!is.null(rez.ym[[i]]))
    print(rez.ym[i])
}


```


```{r Regression fits for unadjusted: young females}

#unadjusted dps by quantile and obj_od
ua.yf.fit1<- svyglm(obj_od ~ quantile.ua1  + race + bmi + smoker + incpov_ratio, design = dsub2, family = "quasibinomial")
ua.yf.sum1 <-summary(ua.yf.fit1)$coefficients[1:4,]

ua.yf.fit2<- svyglm(obj_od ~ quantile.ua2  + race + bmi + smoker + incpov_ratio, design = dsub2, family = "quasibinomial")
ua.yf.sum2 <-summary(ua.yf.fit2)$coefficients[1:4,]

ua.yf.fit3<- svyglm(obj_od ~ quantile.ua3  + race + bmi + smoker + incpov_ratio, design = dsub2, family = "quasibinomial")
ua.yf.sum3 <-summary(ua.yf.fit3)$coefficients[1:4,]

ua.yf.fit4<- svyglm(obj_od ~ quantile.ua4 + race + bmi + smoker + incpov_ratio , design = dsub2, family = "quasibinomial")
ua.yf.sum4 <-summary(ua.yf.fit4)$coefficients[1:4,]

#display significant

rez.yf <-rbind(ua.yf.sum1,ua.yf.sum2,ua.yf.sum3,ua.yf.sum4)

rez.yf<- sapply(rez.yf[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.yf))){
  if (!is.null(rez.yf[[i]]))
    print(rez.yf[i])
}


```

```{r Regression fits for unadjusted: old males}
#unadjusted dps by quantile and obj_od
ua.om.fit1<- svyglm(obj_od ~ quantile.ua1  + race + bmi + smoker + incpov_ratio, design = dsub3, family = "quasibinomial")
ua.om.sum1 <-summary(ua.om.fit1)$coefficients[1:4,]


ua.om.fit2<- svyglm(obj_od ~ quantile.ua2  + race + bmi + smoker + incpov_ratio, design = dsub3, family = "quasibinomial")
ua.om.sum2 <-summary(ua.om.fit2)$coefficients[1:4,]


ua.om.fit3<- svyglm(obj_od ~ quantile.ua3  + race + bmi + smoker + incpov_ratio, design = dsub3, family = "quasibinomial")
ua.om.sum3 <-summary(ua.om.fit3)$coefficients[1:4,]


ua.om.fit4<- svyglm(obj_od ~ quantile.ua4 + race + bmi + smoker + incpov_ratio , design = dsub3, family = "quasibinomial")
ua.om.sum4 <-summary(ua.om.fit4)$coefficients[1:4,]

#display significant

rez.om <-rbind(ua.om.sum1,ua.om.sum2,ua.om.sum3,ua.om.sum4)

rez.om<- sapply(rez.om[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.om))){
  if (!is.null(rez.om[[i]]))
    print(rez.om[i])
}

```


```{r log reg for old females}
#unadjusted dps by quantile and obj_od
ua.of.fit1<- svyglm(obj_od ~ quantile.ua1  + race + bmi + smoker + incpov_ratio, design = dsub4, family = "quasibinomial")
ua.of.sum1 <-summary(ua.of.fit1)$coefficients[1:4,]


ua.of.fit2<- svyglm(obj_od ~ quantile.ua2  + race + bmi + smoker + incpov_ratio, design = dsub4, family = "quasibinomial")
ua.of.sum2 <-summary(ua.of.fit2)$coefficients[1:4,]


ua.of.fit3<- svyglm(obj_od ~ quantile.ua3  + race + bmi + smoker + incpov_ratio, design = dsub4, family = "quasibinomial")
ua.of.sum3 <-summary(ua.of.fit3)$coefficients[1:4,]


ua.of.fit4<- svyglm(obj_od ~ quantile.ua4 + race + bmi + smoker + incpov_ratio , design = dsub4, family = "quasibinomial")
ua.of.sum4 <-summary(ua.of.fit4)$coefficients[1:4,]


#display significant

rez.of <-rbind(ua.of.sum1,ua.of.sum2,ua.of.sum3,ua.of.sum4)

rez.of<- sapply(rez.of[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.of))){
  if (!is.null(rez.of[[i]]))
    print(rez.of[i])
}


```





Adjusted Log. Fits












```{r Regression fits for adjusted: young males}

#unadjusted dps by quantile and obj_od
a.ym.fit1<- svyglm(obj_od ~ quantile.a1 + race + bmi + smoker + incpov_ratio, design = dsub1, family = "quasibinomial")
a.ym.sum1 <-summary(a.ym.fit1)$coefficients[1:4,]


a.ym.fit2<- svyglm(obj_od ~ quantile.a2  + race + bmi + smoker + incpov_ratio, design = dsub1, family = "quasibinomial")
a.ym.sum2 <-summary(a.ym.fit2)$coefficients[1:4,]


a.ym.fit3<- svyglm(obj_od ~ quantile.a3 + race + bmi + smoker + incpov_ratio, design = dsub1, family = "quasibinomial")
a.ym.sum3 <-summary(a.ym.fit3)$coefficients[1:4,]


a.ym.fit4<- svyglm(obj_od ~ quantile.a4 + race + bmi + smoker + incpov_ratio , design = dsub1, family = "quasibinomial")
a.ym.sum4 <-summary(a.ym.fit4)$coefficients[1:4,]




rez.ym <-rbind(a.ym.sum1,a.ym.sum2,a.ym.sum3,a.ym.sum4)

rez.ym<- sapply(rez.ym[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.ym))){
  if (!is.null(rez.ym[[i]]))
    print(rez.ym[i])
}

```

```{r Regression fits for adjusted: young females}

#unadjusted dps by quantile and obj_od
a.yf.fit1<- svyglm(obj_od ~ quantile.a1  + race + bmi + smoker + incpov_ratio, design = dsub2, family = "quasibinomial")
a.yf.sum1 <-summary(a.yf.fit1)$coefficients[1:4,]


a.yf.fit2<- svyglm(obj_od ~ quantile.a2  + race + bmi + smoker + incpov_ratio, design = dsub2, family = "quasibinomial")
a.yf.sum2 <-summary(a.yf.fit2)$coefficients[1:4,]


a.yf.fit3<- svyglm(obj_od ~ quantile.a3  + race + bmi + smoker + incpov_ratio, design = dsub2, family = "quasibinomial")
a.yf.sum3 <-summary(a.yf.fit3)$coefficients[1:4,]


a.yf.fit4<- svyglm(obj_od ~ quantile.a4 + race + bmi + smoker + incpov_ratio , design = dsub2, family = "quasibinomial")
a.yf.sum4 <-summary(a.yf.fit4)$coefficients[1:4,]


#display significant

rez.yf <-rbind(a.yf.sum1,a.yf.sum2,a.yf.sum3,a.yf.sum4)

rez.yf<- sapply(rez.yf[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.yf))){
  if (!is.null(rez.yf[[i]]))
    print(rez.yf[i])
}


```

```{r Regression fits for adjusted: old males}
#unadjusted dps by quantile and obj_od
a.om.fit1<- svyglm(obj_od ~ quantile.a1  + race + bmi + smoker + incpov_ratio, design = dsub3, family = "quasibinomial")
a.om.sum1 <-summary(a.om.fit1)$coefficients[1:4,]


a.om.fit2<- svyglm(obj_od ~ quantile.a2  + race + bmi + smoker + incpov_ratio, design = dsub3, family = "quasibinomial")
a.om.sum2 <-summary(a.om.fit2)$coefficients[1:4,]


a.om.fit3<- svyglm(obj_od ~ quantile.a3  + race + bmi + smoker + incpov_ratio, design = dsub3, family = "quasibinomial")
a.om.sum3 <-summary(a.om.fit3)$coefficients[1:4,]


a.om.fit4<- svyglm(obj_od ~ quantile.a4 + race + bmi + smoker + incpov_ratio , design = dsub3, family = "quasibinomial")
a.om.sum4 <-summary(a.om.fit4)$coefficients[1:4,]


#display significant

rez.om <-rbind(a.om.sum1,a.om.sum2,a.om.sum3,a.om.sum4)

rez.om<- sapply(rez.om[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.om))){
  if (!is.null(rez.om[[i]]))
    print(rez.om[i])
}



```


```{r adjusted log reg for old females}
#unadjusted dps by quantile and obj_od
a.of.fit1<- svyglm(obj_od ~ quantile.a2  + race + bmi + smoker + incpov_ratio, design = diet_sur, family = "quasibinomial")
forest_model(a.of.fit1)
a.of.sum1 <-summary(a.of.fit1)$coefficients[1:4,]


a.of.fit2<- svyglm(obj_od ~ quantile.a2  + race + bmi + smoker + incpov_ratio, design = dsub4, family = "quasibinomial")
a.of.sum2 <-summary(a.of.fit2)$coefficients[1:4,]


a.of.fit3<- svyglm(obj_od ~ quantile.a3  + race + bmi + smoker + incpov_ratio, design = dsub4, family = "quasibinomial")
a.of.sum3 <-summary(a.of.fit3)$coefficients[1:4,]


a.of.fit4<- svyglm(obj_od ~ quantile.a4 + race + bmi + smoker + incpov_ratio , design = dsub4, family = "quasibinomial")
a.of.sum4 <-summary(a.of.fit4)$coefficients[1:4,]


#display significant

rez.of <-rbind(a.of.sum1,a.of.sum2,a.of.sum3,a.of.sum4)

rez.of<- sapply(rez.of[,4], function(x){if (x < 0.05) x <- paste(x,"*",sep = "")})

for(i in c(1:length(rez.of))){
  if (!is.null(rez.of[[i]]))
    print(rez.of[i])
}




#adjusted gets you dps2 and 3
```
```{r plot relative risks by DPS}
"
#unadjusted forest plots of ym
png(file = "for.ym.a1.png", width = 2800, height = 2400, res = 300)
forest_model(a.ym.fit1)
dev.off()

png(file = "for.ym.a2.png", width = 2800, height = 2400, res = 300)
forest_model(a.ym.fit2)
dev.off()

png(file = "for.ym.a3.png", width = 2800, height = 2400, res = 300)
forest_model(a.ym.fit3)
dev.off()

png(file = "for.ym.a4.png", width = 2800, height = 2400, res = 300)
forest_model(a.ym.fit4)
dev.off()



#adjusted forest plots of yf
png(file = "for.yf.a1.png", width = 2800, height = 2400, res = 300)
forest_model(a.yf.fit1)
dev.off()

png(file = "for.yf.a2.png", width = 2800, height = 2400, res = 300)
forest_model(a.yf.fit2)
dev.off()

png(file = "for.yf.a3.png", width = 2800, height = 2400, res = 300)
forest_model(a.yf.fit3)
dev.off()

png(file = "for.yf.a4.png", width = 2800, height = 2400, res = 300)
forest_model(a.yf.fit4)
dev.off()


#adjusted forest plots of om
png(file = "for.om.a1.png", width = 2800, height = 2400, res = 300)
forest_model(a.om.fit1)
dev.off()

png(file = "for.om.a2.png", width = 2800, height = 2400, res = 300)
forest_model(a.om.fit2)
dev.off()

png(file = "for.om.a3.png", width = 2800, height = 2400, res = 300)
forest_model(a.om.fit3)
dev.off()

png(file = "for.om.a4.png", width = 2800, height = 2400, res = 300)
forest_model(a.om.fit4)
dev.off()

#adjusted of
png(file = "for.of.a1.png", width = 2800, height = 2400, res = 300)
forest_model(a.of.fit1)
dev.off()

png(file = "for.of.a2.png", width = 2800, height = 2400, res = 300)
forest_model(a.of.fit2)
dev.off()

png(file = "for.of.a3.png", width = 2800, height = 2400, res = 300)
forest_model(a.of.fit3)
dev.off()

png(file = "for.of.a4.png", width = 2800, height = 2400, res = 300)
forest_model(a.of.fit4)
dev.off()

"
```







```{r Age-stratified old, survey weighted factanal logistic regressions obj_od}


    
    fit1 <- (svyglm(obj_od ~ ua.dp1 + incpov_ratio + smoker + race + bmi, design = dsub4, family = "quasibinomial"))
    g1 <- glm_table_maker(fit1, 13)[1,]
    
    fit2 <- (svyglm(obj_od ~ ua.dp2 + incpov_ratio + smoker + race , design = dsub4, family = "quasibinomial"))
      g2 <- glm_table_maker(fit2, 13)[1,]
    
    fit3 <- (svyglm(obj_od ~ ua.dp3 + + incpov_ratio + smoker + race + bmi, design = dsub4, family = "quasibinomial"))
    g3 <- glm_table_maker(fit3, 13)[1,]
    
    fit3 <- (svyglm(obj_od ~ ua.dp4 +  + incpov_ratio + smoker + race + bmi, design = dsub4, family = "quasibinomial"))
    g4 <- glm_table_maker(fit3, 13)[1,]
    

    
  #resultsOD <- rbind(resultsOD,dsg_names[[i]],glm_table_maker(fit1, 13)[1,],glm_table_maker(fit2, 13)[1,],glm_table_maker(fit3, 13)[1,],glm_table_maker(fit4, 13)[1,])

resultsOD <- rbind(g1,g2,g3,g4)


resultsOD

select(diet, Protein:alcohol)
svyloadings

```


```{r}
resultssOD = data.frame()


    
    fit1 <- (svyglm(sr_od ~ a.dp2 + incpov_ratio + smoker + race + bmi, design = dsub4, family = "quasibinomial"))
      g1 <- glm_table_maker(fit1, 13)
    
    fit2 <- (svyglm(sr_od ~ svdp2 + gender+ Energy + incpov_ratio + smoker + race + bmi, design = dsub1, family = "quasibinomial"))
      g2 <- glm_table_maker(fit2, 13)[1,]
    
    fit3 <- (svyglm(sr_od ~ svdp3 + gender + Energy + incpov_ratio + smoker + race + bmi, design = dsub1, family = "quasibinomial"))
      g3 <- glm_table_maker(fit3, 13)[1,]
    
    fit4 <- (svyglm(sr_od ~ svdp4 + gender+ Energy + incpov_ratio + smoker + race + bmi, design = dsub1, family = "quasibinomial"))
      g4 <- glm_table_maker(fit4, 13)[1,]
    

summary(fit1)




resultsOD <- rbind(g1,g2,g3,g4)
resultsOD


```














```{r Age-stratified GD a}

resultsGD = data.frame()

for (i in c(1:length(dsgs))){

    dsg <- dsgs[[i]]
    
    fit1 <- (svyglm(obj_gd_32nacl ~ svdp1 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    fit2 <- (svyglm(obj_gd_32nacl ~ svdp2 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    fit3 <- (svyglm(obj_gd_32nacl ~ svdp3 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    fit4 <- (svyglm(obj_gd_32nacl ~ svdp4 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    resultsGD <- rbind(resultsGD,dsg_names[[i]],glm_table_maker(fit1, 13)[1,],glm_table_maker(fit2, 13)[1,],glm_table_maker(fit3, 13)[1,],glm_table_maker(fit4, 13)[1,])

}

resultsGD#dp2 is signficant for older mOD

```

```{r Age-stratified Sleep}

resultsSL = data.frame()

for (i in c(1:length(dsgs))){

    dsg <- dsgs[[i]]
    
    fit1 <- (svyglm(sleep ~ svdp1 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    fit2 <- (svyglm(sleep ~ svdp2 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    fit3 <- (svyglm(sleep ~ svdp3 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    fit4 <- (svyglm(sleep ~ svdp4 + gender + incpov_ratio + sr_od + smoker + race + bmi, design = dsg, family = "quasibinomial"))
    
    resultsSL <- rbind(resultsSL,dsg_names[[i]],glm_table_maker(fit1, 13)[1,],glm_table_maker(fit2, 13)[1,],glm_table_maker(fit3, 13)[1,],glm_table_maker(fit4, 13)[1,])

}
resultsSL#dp2 is signficant for older mOD

```


```{r}


cog <- read.xport("Frailty/CFQ_H.xpt")
cog <- select(cog, SEQN, CFDCST1,CFDCST2,CFDCST3,CFDCCS)
colnames(cog) <-  c("rsp_num","cerad1", "cerad2", "cerad3","ceradstatus")
cog <- filter(cog, ceradstatus == 1)

diet_cog <- merge(cog,diet, by = "rsp_num")

diet_cog$cerad <- diet_cog$cerad1 + diet_cog$cerad2 + diet_cog$cerad3
diet_cog$cerad <- as.numeric(diet_cog$cerad)

diet_cog

#survery object with cognition
diet_sur_cog <- svydesign(id = ~msk_var_psu, strata = ~msk_var_strat, weights = ~int_weight, nest = TRUE, data = diet_cog)

dietcog_sub1 <- subset(diet_sur_cog, (diet_cog$gender == 1) & diet_cog$ageNum > 60)

dietcog_sub2 <- subset(diet_sur_cog, (diet_cog$gender == 0) & (diet_cog$ageNum > 60))

#fits

cogfit1 <- svyglm(cerad ~ quantile.a2 + obj_od + incpov_ratio  + smoker + race + bmi, design = dietcog_sub1 , family = "gaussian")

forest_model(cogfit1)    


summary(cogfit1)

cogfit2 <- (svyglm(cerad ~ svdp2 + Energy + obj_od  + incpov_ratio  + smoker + race + bmi, design = dietcog_sub1 , family = "gaussian"))

summary(cogfit2)


```







```{r}
dep <- read.xport("Downloads/NHANES/DataFiles/Frailty/DPQ_H.xpt")
dep <- select(dep, SEQN,DPQ010,DPQ020,DPQ030,DPQ040,DPQ050,DPQ060,DPQ070,DPQ080,DPQ090,DPQ100)

colnames(dep) <-  c("rsp_num","q1", "q2", "q3","q4","q5","q6","q7","q8","q9","q10")
dep$score <- rowSums(dep[2:10],na.rm = TRUE)

diet_dep <- merge(dep,diet, by = "rsp_num")


diet_dep$score<- as.numeric(diet_dep$score)



#survery object with cognition
diet_dep_sur <- svydesign(id = ~msk_var_psu, strata = ~msk_var_strat, weights = ~int_weight, nest = TRUE, data = diet_dep)
dietcog_sub1 <- subset(diet_sur_cog, (diet_cog$sr_od == 0) & diet_cog$education == 5)


#fits

cogfit1 <- (svyglm(score ~ svdp4  + obj_od  + gender + incpov_ratio  + smoker + race + bmi, design = diet_dep_sur, family = "gaussian"))

summary(cogfit1)

cogfit2 <- (svyglm(cerad ~ svdp2 + Energy + obj_od  + incpov_ratio  + smoker + race + bmi, design = dietcog_sub1 , family = "gaussian"))

summary(cogfit2)

```

```{r}
library(kableExtra)

options(knitr.kable.NA = '')

row.names(svyload.a)[3] <- "Total sugar"
row.names(svyload.a)[4] <- "Fiber"
row.names(svyload.a)[5] <- "Total fat"
row.names(svyload.a)[6] <- "Sat. Fat"
row.names(svyload.a)[7] <- "MUFA"
row.names(svyload.a)[8] <- "PUFA"
row.names(svyload.a)[9] <- "Cholesterol"
row.names(svyload.a)[c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30)] <- c("Vitamin A","Beta-Carotene", "Vitamin B1", "Vitamin B2", "Niacin", "Vitamin B6", "Folic Acid", "Vitamin C","Vitamind D","Vitamin K","Calcium","Phosphorous","Magnesium","Iron","Zinc","Copper","Sodium","Potassium","Selenium","Caffeine","Alcohol")

colnames (svyload.a)[c(1:4)] <- c("Fiber/Magnesium DP (17.5%)", "Protein/Selenium DP (11.5%)", "Total Fat/MUFA DP (11.2%)", "Carbs/Alcohol DP (5.8%)")

svyload.a %>%
  kbl(caption = "Table 1: Energy-Adjusted Factor Loadings") %>%
  kable_classic(full_width = F, html_font = "Cambria", ) %>%
  kable_classic_2(font_size = 11) 

write.xlsx(svyload.a, file = "Energy-Adjusted Survey Loadings")

#stacked bargraph
stacked.bplot.loadings <- abs(svyload.a)
for (i in c(1:4)) {
  for(j in c(1:30)) {
    if (abs(stacked.bplot.loadings[j,i]) < 0.5)
      stacked.bplot.loadings[j,i] <- NA
  }
}




#dp1
values <- round(as.vector(unlist(stacked.bplot.loadings[1])),2)
components <- rep(rownames(svyload.a), 1)
DietaryPattern1 <- rep("Magnesium/Potassium/Fiber", 30)

sbp.graph.1 <- data.frame(values,components,DietaryPattern1)
sbp.graph.1 <- sbp.graph.1[order(values),]

mpf.plot <- ggplot(sbp.graph.1, aes(fill = reorder(components, -values*-1), y = values, x = DietaryPattern1)) + geom_bar(position="fill", stat="identity",colour="black") +geom_text(aes(label = values), position = position_fill(vjust = 0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(11,"BuPu"))(7)) + theme_light() + guides(fill=guide_legend(title="Dietary Componenets > 0.5"))
  # this is going to put the legend at the bottom

#dp2
values <- round(as.vector(unlist(stacked.bplot.loadings[2])),2)
components2 <- rep(rownames(svyload.a), 1)
DietaryPattern2 <- rep("Protein/Selenium", 30)

sbp.graph.2 <- data.frame(values,components2,DietaryPattern2)


ps.plot <- ggplot(sbp.graph.2, aes(fill = reorder(components, -values*-1), y = values, x = DietaryPattern2)) + geom_bar(position="fill", stat="identity",colour="black") +geom_text(aes(label = values), position = position_fill(vjust = 0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(11,"BuPu"))(5)) + theme_light() + guides(fill=guide_legend(title="Dietary Components > 0.5"))

#dp3
values <- round(as.vector(unlist(stacked.bplot.loadings[3])),2)
components <- rep(rownames(svyload.a), 1)
DietaryPattern3 <- rep("Total Fat/MUFA", 30)

sbp.graph.3 <- data.frame(values,components,DietaryPattern3)


fat.plot <- ggplot(sbp.graph.3, aes(fill = reorder(components2, -values*-1), y = values, x = DietaryPattern3)) + geom_bar(position="fill", stat="identity",colour="black") +geom_text(aes(label = values), position = position_fill(vjust = 0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(11,"BuPu"))(7)) + theme_light() + guides(fill=guide_legend(title="Dietary Components > 0.5"))

#dp4
values <- round(as.vector(unlist(stacked.bplot.loadings[4])),2)
components <- rep(rownames(svyload.a), 1)
DietaryPattern4 <- rep("Alcohol/Carbs", 30)

sbp.graph.4 <- data.frame(values,components,DietaryPattern4)


alc.plot <- ggplot(sbp.graph.4, aes(fill = reorder(components2, -values*-1), y = values, x = DietaryPattern4,)) + geom_bar(position="fill", stat="identity", colour="black") +geom_text(aes(label = values), position = position_fill(vjust = 0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(9,"BuPu"))(4)) + theme_light() + guides(fill=guide_legend(title="Dietary Components > 0.5"))

ggarrange(nrow = 2, ncol = 2, mpf.plot, ps.plot, fat.plot, alc.plot)



```






















